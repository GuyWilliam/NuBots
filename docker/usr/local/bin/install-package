#!/bin/sh
set -e

# If we are not root, rerun using sudo
if ! [ $(id -u) = 0 ]; then
    sudo "$0" "$@"
else
    # Public keys may have expired since the last time the cached layer was added...
    # So, download the latest version of archlinux-keyring...
    wget https://www.archlinux.org/packages/core/any/archlinux-keyring/download/ -O /var/tmp/archlinux-keyring.pkg.tar.zst
    # And install it.
    pacman -U /var/tmp/archlinux-keyring.pkg.tar.zst --noconfirm

    # Refresh the repository databases, and upgrade any packages if needed.
    pacman -Syu --noconfirm --needed
    # Install the packages if needed.
    pacman -S --noconfirm --needed "$@"
    # Clean up the cache to make the layer smaller.
    rm -rf /var/cache
    rm /var/tmp/archlinux-keyring.pkg.tar.zst
fi
